<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DBS401 - User Profile</title>
    <!-- Add google fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Sansation:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&display=swap"
        rel="stylesheet">
    <!-- CSS Files -->
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/layout.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/profile.css">
    <link rel="stylesheet" href="/css/responsive.css">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="sansation-regular">
    <!-- Navigation -->
    <%- include('./partials/navbar') %>

        <!-- Main Content Section -->
        <section class="section" style="padding-top: 8rem;">
            <div class="section-header">
                <h2 class="section-title sansation-bold">My Profile</h2>
            </div>

            <div class="profile-container">
                <!-- Profile Header -->
                <div class="profile-header">
                    <div class="profile-avatar">
                        <img src="<%= user.avatarUrl %>" alt="Profile Picture" class="profile-image" />
                    </div>
                    <h3 class="profile-name">
                        <%= user.name %>
                    </h3>
                    <p class="profile-role">
                        <%= user.role==='admin' ? 'Administrator' : 'Standard User' %>
                    </p>
                </div>

                <!-- Notification Messages -->
                <% if (typeof req !=='undefined' && req.query.updated==='true' ) { %>
                    <div class="notification success">
                        <i class="fas fa-check-circle"></i> Your profile has been updated successfully!
                    </div>
                    <% } else if (typeof req !=='undefined' && req.query.error==='true' ) { %>
                        <div class="notification error">
                            <i class="fas fa-exclamation-circle"></i> There was an error updating your profile. Please
                            try again.
                        </div>
                        <% } %>

                            <!-- Profile Tabs -->
                            <div class="profile-tabs">
                                <div class="profile-tab active" data-tab="info">Personal Information</div>
                                <div class="profile-tab" data-tab="edit">Edit Profile</div>
                                <div class="profile-tab" data-tab="security">Security</div>
                            </div>

                            <!-- Tab Content: Personal Information -->
                            <div id="info-tab" class="tab-content active">
                                <div class="info-group">
                                    <div class="info-label">Full Name</div>
                                    <div class="info-value">
                                        <%= user.name %>
                                    </div>
                                </div>

                                <div class="info-group">
                                    <div class="info-label">Email Address</div>
                                    <div class="info-value">
                                        <%= user.email || 'Not provided' %>
                                    </div>
                                </div>

                                <div class="info-group">
                                    <div class="info-label">Phone Number</div>
                                    <div class="info-value">
                                        <%= user.phone || 'Not provided' %>
                                    </div>
                                </div>

                                <div class="info-group">
                                    <div class="info-label">Address</div>
                                    <div class="info-value">
                                        <%= user.address || 'Not provided' %>
                                    </div>
                                </div>

                                <div class="info-group">
                                    <div class="info-label">Gender</div>
                                    <div class="info-value">
                                        <%= user.gender || 'Not specified' %>
                                    </div>
                                </div>

                                <div class="info-group">
                                    <div class="info-label">Date of Birth</div>
                                    <div class="info-value">
                                        <%= user.birthdate || 'Not specified' %>
                                    </div>
                                </div>

                                <div class="info-group">
                                    <div class="info-label">Hobbies</div>
                                    <div class="info-value">
                                        <%= user.hobbies || 'Not specified' %>
                                    </div>
                                </div>

                                <div class="info-group">
                                    <div class="info-label">Account Created</div>
                                    <div class="info-value">
                                        <%= user.joinDate || 'Not available' %>
                                    </div>
                                </div>
                            </div>

                            <!-- Tab Content: Edit Profile -->
                            <div id="edit-tab" class="tab-content">
                                <form action="/user/profile/update" method="POST" enctype="multipart/form-data">
                                    <!-- Add avatar upload field -->
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="avatar">Profile Picture</label>
                                            <div class="avatar-upload">
                                                <div class="current-avatar">
                                                    <img src="<%= user.avatarUrl %>" alt="Current Profile Picture"
                                                        id="avatar-preview">
                                                </div>
                                                <div class="avatar-upload-container">
                                                    <input type="file" id="avatar" name="avatar" accept="image/*">
                                                    <div class="preview-change" id="preview-change-text">New image
                                                        selected. Click Save to update your profile.</div>
                                                    <p class="file-hint">Max size: 5MB. Supported formats: JPG, PNG,
                                                        GIF, WEBP</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="name">Full Name</label>
                                            <input type="text" id="name" name="name" value="<%= user.name %>" required>
                                        </div>
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="phone">Phone Number</label>
                                            <input type="tel" id="phone" name="phone" value="<%= user.phone || '' %>">
                                        </div>
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="address">Address</label>
                                            <textarea id="address" name="address"
                                                rows="3"><%= user.address || '' %></textarea>
                                        </div>
                                    </div>

                                    <!-- Add birthdate field -->
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="birthdate">Date of Birth</label>
                                            <input type="date" id="birthdate" name="birthdate">
                                        </div>
                                    </div>

                                    <!-- Add gender field -->
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="gender">Gender</label>
                                            <select id="gender" name="gender" class="form-control">
                                                <option value="" <%=!user.gender || user.gender==='Not specified'
                                                    ? 'selected' : '' %>>Not
                                                    specified</option>
                                                <option value="Male" <%=user.gender==='Male' ? 'selected' : '' %>>Male
                                                </option>
                                                <option value="Female" <%=user.gender==='Female' ? 'selected' : '' %>
                                                    >Female
                                                </option>
                                                <option value="Other" <%=user.gender==='Other' ? 'selected' : '' %>
                                                    >Other
                                                </option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="hobbies">Hobbies (comma separated)</label>
                                            <input type="text" id="hobbies" name="hobbies"
                                                value="<%= user.hobbies || '' %>">
                                        </div>
                                    </div>

                                    <div style="display: flex; justify-content: flex-end; margin-top: 2rem;">
                                        <button type="submit" class="cta-button">
                                            <i class="fas fa-save"></i> Save Changes
                                        </button>
                                    </div>
                                </form>
                            </div>

                            <!-- Tab Content: Security -->
                            <div id="security-tab" class="tab-content">
                                <div class="security-section">
                                    <h4 style="color: var(--accent); margin-bottom: 1rem;">Account Security</h4>

                                    <div class="security-item">
                                        <span class="security-icon"><i class="fas fa-shield-alt"></i></span>
                                        <span>Your account is protected with DBS401 security protocols</span>
                                    </div>

                                    <div class="security-item">
                                        <span class="security-icon"><i class="fas fa-user-lock"></i></span>
                                        <span>Last login: <%= new Date().toLocaleDateString() %> at <%= new
                                                    Date().toLocaleTimeString() %></span>
                                    </div>

                                    <div class="security-item">
                                        <span class="security-icon"><i class="fas fa-fingerprint"></i></span>
                                        <span>Enhanced identity protection active</span>
                                    </div>

                                    <div style="margin-top: 2rem; text-align: right;">
                                        <a href="/logout" class="cta-button"
                                            style="background-color: var(--secondary); color: var(--accent); border: 1px solid var(--accent);">
                                            <i class="fas fa-sign-out-alt"></i> Logout
                                        </a>
                                    </div>
                                </div>
                            </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="footer">
            <div class="logo sansation-bold" style="margin-bottom: 1rem;">DBS<span>401</span></div>
            <ul class="footer-links">
                <li><a href="#"><i class="fab fa-twitter"></i></a></li>
                <li><a href="#"><i class="fab fa-linkedin"></i></a></li>
                <li><a href="#"><i class="fab fa-github"></i></a></li>
                <li><a href="#"><i class="fab fa-discord"></i></a></li>
            </ul>
            <p>© 2023 Database Security 401. All rights reserved.</p>
        </footer>

        <!-- Tab Switching and Dropdown Menu Script -->
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                // Format birthdate for date input
                const birthdateInput = document.getElementById('birthdate');
                const birthdateValue = "<%= user.birthdate %>";

                if (birthdateValue && birthdateValue !== 'Not specified') {
                    try {
                        // Parse the date from the displayed format (MM/DD/YYYY)
                        const parts = birthdateValue.split('/');
                        if (parts.length === 3) {
                            // Convert to YYYY-MM-DD format required by date input
                            const formattedDate = `${parts[2]}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`;
                            birthdateInput.value = formattedDate;
                        }
                    } catch (e) {
                        console.error('Error formatting date:', e);
                    }
                }

                // Image preview functionality
                const avatarInput = document.getElementById('avatar');
                const avatarPreview = document.getElementById('avatar-preview');
                const previewChangeText = document.getElementById('preview-change-text');

                avatarInput.addEventListener('change', function (event) {
                    const file = event.target.files[0];

                    if (file) {
                        // Validate file type and size
                        const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                        const maxSize = 5 * 1024 * 1024; // 5MB

                        if (!validTypes.includes(file.type)) {
                            alert('Please select a valid image file (JPEG, PNG, GIF, WEBP)');
                            avatarInput.value = '';
                            return;
                        }

                        if (file.size > maxSize) {
                            alert('File size exceeds 5MB. Please select a smaller image.');
                            avatarInput.value = '';
                            return;
                        }

                        // Create a FileReader to read and preview the image
                        const reader = new FileReader();

                        reader.onload = function (e) {
                            // Display the image preview
                            avatarPreview.src = e.target.result;

                            // Show the change notification
                            previewChangeText.style.display = 'block';

                            // Add a subtle animation to draw attention to the preview
                            avatarPreview.style.animation = 'pulse 1s';
                            setTimeout(() => {
                                avatarPreview.style.animation = '';
                            }, 1000);
                        }

                        reader.readAsDataURL(file);
                    }
                });

                // Tab switching functionality
                const tabs = document.querySelectorAll('.profile-tab');
                const tabContents = document.querySelectorAll('.tab-content');

                tabs.forEach(tab => {
                    tab.addEventListener('click', function () {
                        const tabId = this.getAttribute('data-tab');

                        // Remove active class from all tabs and contents
                        tabs.forEach(t => t.classList.remove('active'));
                        tabContents.forEach(c => c.classList.remove('active'));

                        // Add active class to current tab and content
                        this.classList.add('active');
                        document.getElementById(tabId + '-tab').classList.add('active');
                    });
                });

                // Dropdown menu functionality (existing code)
                const dropdowns = document.querySelectorAll('.dropdown');

                // Toggle dropdown on click
                dropdowns.forEach(dropdown => {
                    const toggleBtn = dropdown.querySelector('.dropdown-toggle');

                    toggleBtn.addEventListener('click', function (e) {
                        e.preventDefault();
                        dropdown.classList.toggle('active');
                        dropdown.querySelector('.dropdown-menu').classList.toggle('show');

                        // Close other dropdowns
                        dropdowns.forEach(otherDropdown => {
                            if (otherDropdown !== dropdown && otherDropdown.classList.contains('active')) {
                                otherDropdown.classList.remove('active');
                                otherDropdown.querySelector('.dropdown-menu').classList.remove('show');
                            }
                        });
                    });
                });

                // Close dropdowns when clicking outside
                document.addEventListener('click', function (e) {
                    if (!e.target.closest('.dropdown')) {
                        dropdowns.forEach(dropdown => {
                            dropdown.classList.remove('active');
                            dropdown.querySelector('.dropdown-menu').classList.remove('show');
                        });
                    }
                });
            });
        </script>

        <!-- Add a keyframe animation for the pulse effect -->
        <style>
            @keyframes pulse {
                0% {
                    transform: scale(1);
                }

                50% {
                    transform: scale(1.05);
                }

                100% {
                    transform: scale(1);
                }
            }
        </style>
</body>

</html>