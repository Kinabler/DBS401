# Đảm bảo các module cần thiết đã được kích hoạt trong Apache:
# sudo a2enmod proxy proxy_http rewrite headers
# Nếu ứng dụng của bạn sử dụng WebSockets, bạn cũng cần:
# sudo a2enmod proxy_wstunnel

<VirtualHost *:80>
    ServerName your-ctf-domain.com
    # ServerAlias www.your-ctf-domain.com

    # Ghi log truy cập và lỗi
    ErrorLog ${APACHE_LOG_DIR}/ctf-error.log
    CustomLog ${APACHE_LOG_DIR}/ctf-access.log combined

    # Rất quan trọng: Tắt việc Apache cố gắng "dọn dẹp" URL path.
    # Điều này cho phép các chuỗi như ../../ được chuyển tiếp nguyên vẹn.
    # AllowEncodedSlashes NoDecode cũng giúp với các URL chứa ký tự slash đã được mã hóa (%2F).
    AllowEncodedSlashes NoDecode

    # Cấu hình Reverse Proxy
    ProxyRequests Off             # Quan trọng: Tắt chế độ forward proxy
    ProxyPreserveHost On          # Gửi Host header gốc từ client đến backend

    <Proxy *>
        Require all granted
    </Proxy>

    # Chuyển tiếp tất cả request đến ứng dụng backend
    # Sử dụng tùy chọn "nocanon" để Apache không chuẩn hóa (canonicalize) URL path.
    # Điều này rất quan trọng để Path Traversal hoạt động.
    # Thay http://127.0.0.1:8000 bằng địa chỉ và port của ứng dụng CTF của bạn.
    ProxyPass / http://127.0.0.1:8000/ nocanon
    ProxyPassReverse / http://127.0.0.1:8000/

    # Nếu bạn cần chuyển tiếp WebSocket (ví dụ: /socket.io/):
    # RewriteEngine on
    # RewriteCond %{HTTP:Upgrade} websocket [NC]
    # RewriteCond %{HTTP:Connection} upgrade [NC]
    # RewriteRule ^/?(.*) "ws://127.0.0.1:8000/$1" [P,L]

    # Thiết lập các header cần thiết cho ứng dụng backend
    # X-Forwarded-For giúp backend biết IP gốc của client
    RequestHeader set X-Forwarded-For %{REMOTE_ADDR}s
    RequestHeader set X-Forwarded-Proto %{REQUEST_SCHEME}s

    # Các tùy chỉnh khác nếu cần
    # Ví dụ: tăng giới hạn kích thước request body nếu thử thách yêu cầu upload file lớn
    # LimitRequestBody 52428800 # 50MB

    # Tắt các cơ chế bảo vệ có thể can thiệp (nếu có)
    # Ví dụ: nếu ModSecurity được cài đặt và kích hoạt, nó có thể chặn payload.
    # Bạn có thể cần phải tắt nó cho VirtualHost này nếu nó gây cản trở.
    # <IfModule mod_security2.c>
    #     SecRuleEngine Off
    # </IfModule>

</VirtualHost>
